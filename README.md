# クレジットカードのキャンペーン反応予測

本ハンズオンでは、クレジットカードの顧客の属性、利用履歴、過去実際にキャンペーンを行った際の反応実績をサンプルデータとして使用し、予測モデルを作成します。
その後、現在の顧客情報を当てはめることで次回キャンペーンを行った場合の反応確度を予測します。
得られる予測結果を元に費用対効果を最大にするターゲットリストを作成します。

![image](./images/001.png)

本ハンズオンを通じて、1からこのストリーム([完成版ストリームファイル.str](./完成版ストリームファイル.str))を作成していきます。</br>
![image](./images/002.png)

## 1. プロジェクトへのアクセス

Cloud Pak for Dataのホーム画面で、**すべてのプロジェクト**をクリックします。</br>
![image](./images/1.png)

プロジェクト画面で、**ml_ご自身の番号**のプロジェクトをクリックします。</br>
![image](./images/2.png)

以下の様にプロジェクトのホーム画面が表示されたら、プロジェクトのアクセス完了です。</br>
![image](./images/3.png)

## 2. 資産の作成

**アセットタブ**に切り替えて、**新規資産**をクリックします。</br>
![image](./images/4.png)

新規資産画面が表示されたら、モデルの処理に表示されている**ビジュアル・フローとしてのモデル作成**をクリックします。</br>
![image](./images/5.png)

SPSS Modeler Flowの作成画面が表示されたら、任意の名前を設定し**作成**をクリックします。</br>

![image](./images/6.png)

少し待つと、SPSS Modeler Flowが利用できます。</br>
![image](./images/7.png)

## 3. データの読み込み

このリポジトリをダウンロードし、[dataフォルダ](./data)に入っている以下のCSVファイルをすべて画面右側の点線で囲まれた部分にアップロードします。</br>
|ファイル名|
|:--|
|顧客属性_実績.csv|
|顧客属性_予測.csv|
|反応_実績.csv|
|利用履歴_実績.csv|
|利用履歴_予測.csv|

![image](./images/8.png)

アップロードが正常に完了するとこの画面になります。</br>
![image](./images/9.png)

インポートパレットから、**データ資産**ノードをフロー・キャンバスにドラッグ＆ドロップします。</br>
![image](./images/10.png)

**データ資産**ノードをダブルクリックします。</br>
![image](./images/11.png)

データ資産の選択画面が表示されたら、**データアセット** > **利用履歴_実績.csv**を選択し、**選択**をクリックします。</br>
![image](./images/12.png)

デフォルト設定のまま**保存**をクリックします。</br>
![image](./images/13.png)

先ほど配置したノードの名前が**利用履歴_実績.csv**に自動で切り替わります。</br>
![image](./images/018.png)

ノードにカーソルを合わせて、三点リーダーから**データのプレビュー**を選択してみてください。</br>
![image](./images/14.png)

読み込んだデータの中身を画面上で確認することができます。</br>
![image](./images/15.png)

同様の手順で、**利用履歴_実績.csv**と**反応_実績.csv**をフロー・キャンバスに追加します。</br>
![image](./images/16.png)

## 4. データの前処理（エンコーディング）

利用履歴データを顧客毎・用途毎に「使った/使わなかった」のフラグに変換し、縦持ちのデータを横持ちに簡単に変換します。</br>
![image](./images/021.png)

利用履歴(実績)のデータ型を読み込みます。</br>
フィールド操作パレットから、**タイプ**ノードをフロー・キャンバスにドラッグ＆ドロップし、**利用履歴_実績.csv→タイプ**と接続します。</br>
![image](./images/17.png)

> **<font color="blue">ノード同士の接続方法</font>**
> 接続元のノードにマウスカーソルを置くと、**＞マーク**が表示されます。
> **＞マーク**をドラッグし接続先のノードの上で離すとノードの接続ができます。
> ![index](./images/023.gif)

**タイプ**ノードをダブルクリックします。
**値の読み込み**をクリックし、読み込みが完了したら**保存**をクリックします。</br>
![image](./images/18.png)

フィールド操作パレットから、**フラグ設定**ノードをフロー・キャンバスにドラッグ＆ドロップし、**タイプ→フラグ設定**と接続します。</br>
![image](./images/19.png)

**フラグ設定**ノードをダブルクリックします。
セット型フィールドは**用途**を選択し、**値の追加**をクリックします。</br>
![image](./images/20.png)

**全てのチェックボックスをON**にして**OK**をクリックします。</br>
![image](./images/22.png)

**集計キーをON**にして**列の追加**をクリックします。</br>
![image](./images/21.png)

**顧客番号をON**にして**OK**をクリックします。</br>
![image](./images/23.png)

**保存**をクリックします。</br>
![image](./images/24.png)

データの加工が意図した通りにできているか確認をします。
出力パレットから、**表**ノードをフロー・キャンバスにドラッグ＆ドロップし、**フラグ設定→表**と接続します。</br>
![image](./images/25.png)

表ノードにカーソルを合わせて、三点リーダーから**実行**をクリックします。
少し待つと、画面右側に出力の実行結果が表示されるので、一番上の出力結果をクリックします。</br>
![image](./images/26.png)

> 実行結果は、右上にある赤枠のアイコンをクリックし、出力タブに切り替えることで確認できます。
> ![image](./images/033.png)

上手く顧客番号毎にどの用途で利用したかを横持ちのテーブルに変換できました。</br>
![image](./images/27.png)

## 5. データの前処理（レコード結合）

先ほど作成した利用履歴フラグと、顧客属性・反応を顧客番号をキーに1つに結合します。</br>
![image](./images/035.png)

レコード操作パレットから、**マージ**ノードをフロー・キャンバスにドラッグ＆ドロップし、</br>
**フラグ設定→マージ**
**顧客属性_実績.csv→マージ**
**反応_実績.csv→マージ**</br>
と接続します。</br>
![image](./images/28.png)

**マージ**ノードをダブルクリックします。
マージ欄のマージ法に**キー**を選択し、**列の追加**をクリックします。</br>
![image](./images/29.png)

**顧客番号をON**にし、**OK**をクリックします。</br>
![image](./images/30.png)

**保存**をクリックします。</br>
![image](./images/31.png)

再度、マージノードによって得られるデータが意図したものか確認するため、一度表ノードに出力します。
ノードを使い回しするため、先ほど使用した**フラグ設定と表の接続を解除**してください。</br>

> **<font color="blue">ノードの接続解除方法</font>**
> 削除したい接続(→)を右クリックし、**削除**をクリックすると接続が解除できます。
> ![image](./images/040.gif)

接続の解除ができたら、**マージ→表**と接続します。</br>
![image](./images/32.png)

**表**ノードにカーソルを合わせて、三点リーダーから**実行**をクリックします。
少し待つと、画面右側に出力の実行結果が表示されるので、一番上の出力結果をクリックします。</br>
![image](./images/33.png)

上手く顧客番号をキーに3つのテーブルを結合できました。</br>
![image](./images/34.png)

> マージは、キーとなる項目が必要です。
> 各入力データでキーとなる項目名は同じである必要があります。
> キー項目の名称が異なる場合はマージの前に項目名を変更するノード(フィルターノード)を使用します。
> 例）cutomer_number → 顧客番号など

## 6. データの前処理（特徴量抽出）

生データから、予測に役立つ特徴量を抽出します。
生年月日そのものはキャンペーン反応に影響を及ぼさないが、年齢は影響を及ぼすだろう、というデータや業務に対する知識が必要です。
適切なデータを利用して適切な特徴量を設定することが、予測分析の精度を向上するための最も有効な方法です。
今回は、**生年月日から2024年9月25日時点での年齢**を算出します。</br>
![image](./images/044.png)

フィールド操作パレットから、**フィールド作成**ノードをフロー・キャンバスにドラッグ＆ドロップし、</br>
**マージ→フィールド作成**
**フィールド作成→表**</br>
と接続し直します。</br>
> 既存の接続間にノードを追加したい場合、→の上に追加したいノードをドラッグ＆ドロップすることで簡単に追加することができます。
> ![image](./images/045.gif)

![image](./images/46.png)

フィールド作成ノードをダブルクリックし、派生フィールド名に生成する列名として**年齢**と入力します。
式の下にあるアイコンをクリックし、年齢を算出する式を作成します。</br>
![image](./images/47.png)

式ビルダーが表示されたら、**関数**をクリックします。
**date_years**と入力し、date_years_difference関数を追加します。</br>
![image](./images/48.png)

関数式に使用する1つ目の項目を選択します。
**フィールド**をクリックし、**生年月日**を追加します。</br>
![image](./images/49.png)

関数式に使用する2つ目の項目を入力します。
**式のテキストボックス**をクリックし、``?`` を ``'2024-09-25'``に書き換えます。</br>

![image](./images/50.png)

> 式が下記画像の状態になっていることを確認してください。
> ![image](./images/51.png)</br>
> 違っていた場合、手入力も可能なので以下の式へ修正してください。
> ```text
> date_years_difference(生年月日,'2024-09-25')
> ```

**保存**をクリックします。</br>
![image](./images/52.png)

**表**ノードを実行し、出力結果を表示します。
生年月日から、2024年9月25日時点での年齢が算出できました。</br>
![image](./images/53.png)

> 今回の様な「生年月日から年齢を算出」などの算出処理では主に、**フィールド追加**ノードを利用します。
> 式には、条件分岐などを設定して複雑な計算をすることも可能です。</br>

ここまでで、データの前処理は完了です。

## 7. データ視覚化（データ検査）

集約・結合・特徴量抽出などがひとまず出来た段階でデータの可視化を行い、データ加工が適切か確認します。
出力パレットから、**データ検査**ノードをフロー・キャンバスにドラッグ＆ドロップし、**フィールド作成→データ検査**と接続します。</br>
![image](./images/54.png)

**データ検査**ノードを実行し、出力結果を表示します。
各項目のグラフ描画・基本的な統計量算出・欠損値の検査を網羅的に行い、想定外の値・分布・欠損値が確認できます。</br>
![image](./images/55.png)
![image](./images/56.png)

## 8. データ視覚化（散布図）

次に、複数の項目間の関連を視覚化して確認します。
グラフパレットから、**散布図**ノードをフロー・キャンバスにドラッグ＆ドロップし、**フィールド作成→散布図**と接続します。</br>
![image](./images/57.png)

**散布図**ノード(ノード名が`?v. ?`になっています)をダブルクリックし、散布図セクションでX軸Y軸に使用する項目を選択します。</br>
![image](./images/58.png)

オーバーレイセクションで色に**キャンペーン反応**を選択し、**保存**をクリックします。</br>
![image](./images/59.png)

散布図ノード(ノード名が`年齢v. 年収`になっています)を実行し、出力結果を表示します。</br>
![image](./images/60.png)

グラフからデータの抽出範囲を検討し、今回のキャンペーンのターゲットを20〜50代・年収200万以上に設定します。</br>
![image](./images/61.png)

レコード操作パレットから、**条件抽出**ノードを年齢ノードと表ノードの間にドラッグ＆ドロップし、</br>
**年齢→選択**
**選択→表**</br>
と接続し直します。</br>
![image](./images/63.png)

条件に以下の式を貼り付けて、**保存**をクリックしてください。</br>
```text
'年齢' >= 20 and '年齢' <= 60 and '年収' >= 2000000 and '年収' <= 10000000
```
![image](./images/64.png)

> 余裕のある方は目的の領域が抽出できていることをグラフで確認してみてください。
> ![image](./images/65.png)

## 9. 分類（セグメンテーション）

利用履歴が似ているグループ(クラスター/セグメント)に自動的に分類します。
クラスタリング、クラスター分析とも呼ばれ、顧客セグメント毎の施策立案などに活用されます。
フィールド操作パレットから、**タイプ**ノードをフロー・キャンバスにドラッグ＆ドロップし、**条件抽出→タイプ**と接続します。
**タイプ**ノードをダブルクリックします。</br>
![image](./images/66.png)

**値の読み込み**をクリックし、ロールを以下の通り設定して**保存**をクリックします。</br>
|フィールド|ロール|
|:-|:-|
|顧客番号|レコードID|
|各用途_|入力|
|上記以外|なし|

![image](./images/67.png)

モデル作成パレットから、**K-Means**ノードをフロー・キャンバスにドラッグ＆ドロップし、**タイプ→K-Means**と接続します。
K-Meansノードを**実行**します。</br>
![image](./images/68.png)

K-Meansのモデルナゲットが生成されたら、**モデルの表示**をクリックします。</br>
![image](./images/69.png)

モデルの詳細が表示されたら、**クラスター**を選択します。
クラスター1は以下の様な特徴を持つことがわかります。</br>

- 旅行代理店は全く使わない
- ETCと宿泊施設はよく使う
- 百貨店はあまり使わない

![image](./images/70.png)

次に**クラスターの比較**を選択します。
ここでは各用途毎に円の大きさでクラスター間の比較ができます。</br>

![image](./images/71.png)

## 10. 予測（教師あり学習）

教師あり学習の一種である、CART決定木を用いて予測モデルを作成します。
キャンペーン反応の確度が高いグループと低いグループに分岐していき、最終的に樹木の様に枝分かれした樹形図を作成します。
フィールド操作パレットから、**パーティション**ノードをフロー・キャンバスにドラッグ＆ドロップし、**条件抽出→パーティション**と接続します。</br>
![image](./images/72.png)

フィールド操作パレットから、**タイプ**ノードをフロー・キャンバスにドラッグ＆ドロップし、**パーティション→タイプ**と接続します。</br>
![image](./images/73.png)

タイプノードをダブルクリックし、**値の読み込み**をクリックします。
ロールを以下の通り設定して**保存**をクリックします。</br>
|フィールド|ロール|
|:-|:-|
|顧客番号|レコードID|
|生年月日|なし|
|居住地区|なし|
|持ち家|なし|
|キャンペーン反応|対象|
|データ区分|パーティション|
|上記以外|入力|

![image](./images/74.png)

モデル作成パレットから、**C&R ツリー**ノードをフロー・キャンバスにドラッグ＆ドロップし、**タイプ→C&R ツリー**と接続します。
C&R ツリーノード(ノード名がキャンペーン反応になっています)を**実行**します。</br>
![image](./images/75.png)

C&R ツリーのモデルナゲットが生成されたら、**モデルの表示**をします。</br>
![image](./images/76.png)

モデルの詳細が表示されたら、**ツリー図**を選択します。
赤枠で囲った部分は、「航空会社・旅行代理店を使わず、ETC・宿泊施設を使う顧客のキャンペーンの反応確度は56％である」といったルールの集まりになります。</br>
![image](./images/77.png)

## 11. 学習とテスト

先ほど作成した予測モデルの予測精度を検証します。
パーティションノードによって実績データの一部を学習用に、残りをテスト用に分割して実施します。</br>
![image](./images/083.png)

出力パレットから、**データ検査**ノードをフロー・キャンバスにドラッグ＆ドロップし、**キャンペーン反応→データ検査**と接続します。</br>
![image](./images/78.png)

**精度分析**ノードをダブルクリックし、**一致行列**と**評価メトリック**のチェックを**ON**にして、**保存**をクリックします。</br>
![image](./images/79.png)

**精度分析**ノードを**実行**し、出力結果を表示します。
学習・テストの両方に対して、正答率などを表示できます。
目標としている精度を達成しているかや、過学習（学習データに対しては予測精度が高いのに、テストデータに対しては精度が低いこと）が発生していないかの確認ができます。</br>
![image](./images/80.png)

## 12. オプション

フロー・キャンバスの処理内容をわかりやすくするため、コメントを追加することができます。
**選択**ノードをダブルクリックして、右上の鉛筆マークをクリックし`年齢20代から50代、年収200万以上で条件抽出`と入力したら、**保存**をクリックします。</br>
![image](./images/81.png)

こうすることで、フロー・キャンバス上のノード名が入力した内容に変わります。
どの様な条件で抽出を行っているか、一目でわかる様になりました。</br>
![image](./images/82.png)

フロー・キャンバス上の何もない場所で右クリックをし、**新規コメント**をクリックするとテキストボックスが追加されるので、`学習：実績データから予測モデルを作成`と入力します。フロー・キャンバスのどの部分がどの様な処理を行うかを説明することができます。</br>
![image](./images/83.png)

以上で学習ステップは完了です。</br>
![image](./images/84.png)

## 13. 予測ステップ

学習ステップで行ったデータ加工と同じ処理を予測データに対して実施します。
データの読み込みステップと同様の手順で、**利用履歴_予測.csv**と**顧客属性_予測.csv**をフロー・キャンバスに追加します。</br>
![image](./images/85.png)

学習ステップから、**タイプ**・**フラグ設定**・**マージ**・**年齢**・**選択**ノードをまとめてコピー＆貼り付けをします。</br>
![image](./images/86.png)

**利用履歴_予測.csv→タイプ**、**顧客属性_予測.csv→マージ**と接続します。</br>
![image](./images/87.png)

先ほどと同様に学習ステップから、モデルナゲットを全てコピー＆貼り付けをします。</br>
![image](./images/88.png)

出力パレットから、**表**ノードを3つフロー・キャンバスにドラッグ＆ドロップし、</br>
**生成→各モデルナゲット**
**各モデルナゲット→表**</br>
と接続します。</br>
![image](./images/89.png)

各表ノードを右クリックし、**実行**をクリックし予測結果を見てみます。</br>
![image](./images/90.png)

予測結果のフィールドはモデルの手法によって自動で命名・追加されます。
予測結果は画面への表示だけでなく、ファイルやRDBへ書き出すことも可能です。</br>

- 分類（セグメンテーション）の予測結果
  各顧客が分類されるクラスター（グループ）を提示しています。
  ![image](./images/91.png)

- 予測（教師あり学習）の予測結果
  各顧客がキャンペーンに反応する予測値とその確度を提示しています。
  予測値がTかつ確度が高い顧客から順に、次回キャンペーンのターゲットにすることで、限られたコストで最大限の効果をあげることができます。
  ![image](./images/92.png)

以上で本ハンズオンは終了です。